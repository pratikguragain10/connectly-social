{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}
<style>
/* ================= GLOBAL (UPDATED) ================= */
body {
  background:
    radial-gradient(circle at top left, #c7d2fe 0%, transparent 40%),
    radial-gradient(circle at bottom right, #bae6fd 0%, transparent 40%),
    linear-gradient(180deg, #f8fafc, #eef2ff);
}

/* soft canvas texture */
.home-layout::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: radial-gradient(#ffffff 1px, transparent 1px);
  background-size: 120px 120px;
  opacity: 0.25;
  pointer-events: none;
  z-index: -1;
}

/* ================= PAGE LAYOUT ================= */
.home-layout {
  display: grid;
  grid-template-columns: 260px minmax(600px, 680px) 260px;
  gap: 20px;
  justify-content: center;
  padding: 0 14px;
  height: calc(100vh - 64px);
}

/* ================= LEFT ================= */
.left-sidebar {
  position: sticky;
  top: 72px;
  height: calc(100vh - 72px);
  overflow-y: auto;
}

.sidebar-card {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.95),
    rgba(255,255,255,.85)
  );
  backdrop-filter: blur(14px);
  border-radius: 18px;
  padding: 12px;
  border: 1px solid rgba(255,255,255,.6);
  box-shadow: 0 12px 32px rgba(0,0,0,.08);
}

.sidebar-item {
  display:flex;
  gap:12px;
  padding:12px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  transition: background .15s ease;
}

.sidebar-item:hover {
  background:#f0f2f5;
}

.sidebar-item:first-child {
  background:#e7f3ff;
  color:#0866ff;
}

/* ================= FEED ================= */
.feed {
  height: calc(100vh - 72px);
  overflow-y: auto;
  padding-right: 6px;
}

/* ================= CREATE POST ================= */
.create-post {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.95),
    rgba(255,255,255,.85)
  );
  backdrop-filter: blur(14px);
  border-radius: 20px;
  padding: 16px;
  margin-bottom: 18px;
  border: 1px solid rgba(255,255,255,.6);
  box-shadow: 0 14px 36px rgba(0,0,0,.10);
}

.create-post-top {
  display:flex;
  gap:12px;
}

.create-post-top img {
  width:42px;
  height:42px;
  border-radius:50%;
}

.create-post-top textarea {
  flex:1;
  border-radius:22px;
  padding:12px 16px;
  border:none;
  background:#f0f2f5;
}

.create-post-actions {
  display:flex;
  justify-content:space-between;
  margin-top:14px;
  border-top:1px solid #e5e7eb;
  padding-top:12px;
}

/* ================= POST ================= */
.post-card {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.95),
    rgba(255,255,255,.85)
  );
  backdrop-filter: blur(14px);
  border-radius: 20px;
  padding: 16px;
  margin-bottom: 18px;
  border: 1px solid rgba(255,255,255,.6);
  box-shadow:
    0 16px 40px rgba(0,0,0,.10),
    0 40px 80px rgba(0,0,0,.08);
  transition: transform .2s ease, box-shadow .2s ease;
}

.post-card:hover {
  transform: translateY(-3px);
  box-shadow:
    0 20px 48px rgba(0,0,0,.14),
    0 60px 120px rgba(0,0,0,.12);
}

.post-user img {
  width:42px;
  height:42px;
  border-radius:50%;
}

/* ================= POST MEDIA ================= */
.post-media {
  margin-top:12px;
  border-radius:18px;
  overflow:hidden;
  box-shadow: 0 14px 36px rgba(0,0,0,.20);
}

.post-media img,
.post-media video {
  width:100%;
  max-height:520px;
  object-fit:cover;
}

/* ================= POST ACTIONS ================= */
.post-actions {
  display:flex;
  justify-content:space-around;
  border-top:1px solid #e5e7eb;
  padding-top:10px;
}

.post-actions button {
  background:none;
  border:none;
  font-weight:600;
  cursor:pointer;
  color:#6b7280;
  padding:10px 18px;
  border-radius:12px;
  transition: background .15s ease, transform .1s ease;
}

.post-actions button:hover {
  background:#f0f2f5;
}

.post-actions button.liked {
  color:#2563eb;
}

/* ================= RIGHT ================= */
.right-sidebar {
  position: sticky;
  top: 72px;
  height: calc(100vh - 72px);
  overflow-y: auto;
}

.contacts {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,.95),
    rgba(255,255,255,.85)
  );
  backdrop-filter: blur(14px);
  border-radius: 18px;
  padding: 14px;
  border: 1px solid rgba(255,255,255,.6);
  box-shadow: 0 14px 36px rgba(0,0,0,.10);
}

.contact {
  display:flex;
  gap:12px;
  padding:10px;
  border-radius:12px;
}
.contact:hover { background:#f0f2f5; }

.contact img {
  width:34px;
  height:34px;
  border-radius:50%;
}

/* ================= MOBILE ================= */
@media(max-width:1200px){
  .home-layout { grid-template-columns: minmax(600px, 1fr) 260px; }
  .left-sidebar { display:none; }
}

@media(max-width:900px){
  .home-layout { grid-template-columns: 1fr; }
  .right-sidebar { display:none; }
}

/* ================= POST HEADER ================= */
.post-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* ================= POST MENU CONTAINER ================= */
.post-menu {
  position: relative;
}

/* ================= POST MENU BUTTON ================= */
.post-menu-btn {
  background: #f0f2f5;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.post-menu-btn:hover {
  background: #e4e6eb;
}

/* ================= POST MENU DROPDOWN ================= */
.post-menu-dropdown {
  position: absolute;
  right: 0;
  top: 44px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 12px 28px rgba(0,0,0,.18);
  width: 200px;
  display: none;
  z-index: 50;
  padding: 6px;
}

/* ================= MENU ITEMS (FINAL FIX) ================= */
.post-menu-dropdown a,
.post-menu-dropdown form button {
  all: unset;                  /* üî• removes blue link + borders */
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  color: #050505;
  width: 100%;
  box-sizing: border-box;
}

/* Hover */
.post-menu-dropdown a:hover,
.post-menu-dropdown form button:hover {
  background: #f0f2f5;
}

/* Delete action (Facebook-like red) */
.post-menu-dropdown form button {
  color: #e11d48;
}

/* ================= POST META SPACING ================= */
.post-user small {
  display: block;
  margin-top: 4px;
  color: #6b7280;
  font-size: 13px;
}

.post-text {
  margin-top: 8px;
  font-size: 15px;
  line-height: 1.5;
}

/* ================= MEDIA PREVIEW ================= */
.create-post-preview {
  display: none;
  position: relative;
  margin-top: 12px;
}

.create-post-preview img,
.create-post-preview video {
  width: 100%;
  border-radius: 16px;
}

/* ================= PREVIEW CLOSE BUTTON ================= */
.preview-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  font-size: 16px;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
}

/* ================= CLEAN FILE INPUT ================= */
.create-post-actions input[type="file"] {
  display: none;
}

.create-post-actions label {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 12px;
  cursor: pointer;
}

.create-post-actions label:hover {
  background: #f0f2f5;
}

</style>

<div class="home-layout">

<!-- LEFT -->
<aside class="left-sidebar">
  <div class="sidebar-card">
    <div class="sidebar-item">üë§ {{ user.username }}</div>
    <div class="sidebar-item">üë• Friends</div>
    <div class="sidebar-item">üïí Memories</div>
    <div class="sidebar-item">üîñ Saved</div>
    <div class="sidebar-item">üë™ Groups</div>
    <div class="sidebar-item">üõí Marketplace</div>
  </div>
</aside>

<!-- FEED -->
<main class="feed">

<!-- CREATE POST -->
<div class="create-post">
<form method="POST" enctype="multipart/form-data">
{% csrf_token %}

<div class="create-post-top">
  <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://picsum.photos/40{% endif %}">
  <textarea name="content" rows="2"
            placeholder="What's on your mind, {{ user.username }}?"
            style="width:100%;border-radius:20px;padding:10px;border:none;background:#f0f2f5;"></textarea>
</div>

<!-- MEDIA PREVIEW (MOVED OUTSIDE FLEX CONTAINER) -->
<div class="create-post-preview preview-wrapper" id="postPreview">
  <button type="button" class="preview-close" onclick="clearHomePreview()">‚úï</button>
  <img id="imagePreview" style="display:none;">
  <video id="videoPreview" controls style="display:none;"></video>
</div>

<div class="create-post-actions">
  <label>üì∑ Photo
    <input type="file" name="image" accept="image/*" onchange="previewImage(this)">
  </label>
  <label>üé• Video
    <input type="file" name="video" accept="video/*" onchange="previewVideo(this)">
  </label>
  <button type="submit">Post</button>
</div>

</form>
</div>

<!-- POSTS -->
{% for post in posts %}
<div class="post-card">

<div class="post-header">
  <div class="post-user">
    <img src="{% if post.user.profile_picture %}{{ post.user.profile_picture.url }}{% else %}https://picsum.photos/40{% endif %}">
    <div>
      <strong>{{ post.user.username }}</strong><br>
      <small>{{ post.created_at|date:"M d, Y H:i" }}</small>
    </div>
  </div>

  {% if post.user.id == request.session.user_id %}
  <div class="post-menu">
    <button class="post-menu-btn" onclick="togglePostMenu({{ post.id }})">‚ãØ</button>
    <div class="post-menu-dropdown" id="post-menu-{{ post.id }}">
      <a href="{% url 'edit_post' post.id %}">‚úèÔ∏è Edit post</a>
      <form method="POST" action="{% url 'delete_post' post.id %}">
        {% csrf_token %}
        <button>üóë Delete post</button>
      </form>
    </div>
  </div>
  {% endif %}
</div>

{% if post.content %}<div class="post-text">{{ post.content }}</div>{% endif %}
{% if post.image %}<div class="post-media"><img src="{{ post.image.url }}"></div>{% endif %}
{% if post.video %}<div class="post-media"><video controls src="{{ post.video.url }}"></video></div>{% endif %}

<div class="post-actions">
<form method="POST" action="{% url 'like_post' post.id %}">
{% csrf_token %}
<button class="{% if post.is_liked %}liked{% endif %}">üëç Like</button>
</form>
<button onclick="toggleComments(this)">üí¨ Comment</button>
</div>

<!-- COMMENTS -->
<div class="comment-box" style="display:none;">
<form method="POST" action="{% url 'add_comment' post.id %}">
{% csrf_token %}
<input class="comment-input" name="content" placeholder="Write a comment..." required>
</form>

{% for comment in post.comments.all %}
{% if not comment.parent %}
<div class="comment">
<strong>{{ comment.user.username }}</strong> {{ comment.content }}

<div class="comment-actions">
<form method="POST" action="{% url 'like_comment' comment.id %}">
{% csrf_token %}
<button>üëç {{ comment.likes.count }}</button>
</form>
<button onclick="toggleReply(this)">Reply</button>
</div>

<div class="reply-box" style="display:none;">
<form method="POST" action="{% url 'add_comment' post.id %}">
{% csrf_token %}
<input type="hidden" name="parent" value="{{ comment.id }}">
<input class="comment-input" name="content" placeholder="Write a reply..." required>
</form>
</div>

{% for reply in comment.children.all %}
<div class="comment reply-box">
<strong>{{ reply.user.username }}</strong> {{ reply.content }}
</div>
{% endfor %}
</div>
{% endif %}
{% endfor %}
</div>

</div>
{% endfor %}

</main>

<!-- RIGHT -->
<aside class="right-sidebar">
<div class="contacts">
<h4>Contacts</h4>
{% for friend in contacts %}
<div class="contact">
<img src="{% if friend.profile_picture %}{{ friend.profile_picture.url }}{% else %}https://picsum.photos/32{% endif %}">
{{ friend.username }}
</div>
{% empty %}
<p style="color:#65676b;font-size:14px;">No contacts yet</p>
{% endfor %}
</div>
</aside>

</div>

<script>
function toggleComments(btn){
  const card = btn.closest('.post-card');
  const box = card.querySelector('.comment-box');
  box.style.display = box.style.display === 'block' ? 'none' : 'block';
}

function toggleReply(btn){
  const box = btn.parentElement.nextElementSibling;
  box.style.display = box.style.display === 'block' ? 'none' : 'block';
}

function togglePostMenu(id){
  const menu = document.getElementById('post-menu-' + id);
  document.querySelectorAll('.post-menu-dropdown').forEach(m => {
    if(m !== menu) m.style.display = 'none';
  });
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

document.addEventListener('click', function(e){
  if(!e.target.closest('.post-menu')){
    document.querySelectorAll('.post-menu-dropdown')
      .forEach(m => m.style.display = 'none');
  }
});

/* ===== MEDIA PREVIEW LOGIC (ADD ONLY) ===== */
function previewImage(input){
  const file = input.files[0];
  if(!file) return;

  const img = document.getElementById('imagePreview');
  const video = document.getElementById('videoPreview');
  const box = document.getElementById('postPreview');
  const closeBtn = box.querySelector('.preview-close');

  img.src = URL.createObjectURL(file);
  img.style.display = 'block';
  video.style.display = 'none';
  box.style.display = 'block';
  closeBtn.style.display = 'flex';
}

function previewVideo(input){
  const file = input.files[0];
  if(!file) return;

  const img = document.getElementById('imagePreview');
  const video = document.getElementById('videoPreview');
  const box = document.getElementById('postPreview');
  const closeBtn = box.querySelector('.preview-close');

  video.src = URL.createObjectURL(file);
  video.style.display = 'block';
  img.style.display = 'none';
  box.style.display = 'block';
  closeBtn.style.display = 'flex';
}


function clearHomePreview(){
  const box = document.getElementById('postPreview');
  const img = document.getElementById('imagePreview');
  const video = document.getElementById('videoPreview');

  box.style.display = 'none';
  img.src = '';
  video.src = '';
  img.style.display = 'none';
  video.style.display = 'none';

  box.closest('form').querySelector('input[name="image"]').value = '';
  box.closest('form').querySelector('input[name="video"]').value = '';
}

</script>

{% endblock %}
